version: '3.8'

services:
  # ============================================
  # TRAEFIK REVERSE PROXY
  # ============================================
  reverse-proxy:
    image: traefik:v3.2
    container_name: reverse-proxy
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=DEBUG"
      - "--accesslog=true"
    ports:
      - "80:80"       # HTTP
      - "8080:8080"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - energy-network
    labels:
      - "traefik.enable=true"

      # === DEFINIȚIA MIDDLEWARE-ULUI PENTRU VALIDARE JWT (Corectat) ===
      - "traefik.http.middlewares.jwt-verify.forwardauth.address=http://auth-service:8083/auth/validate"
      - "traefik.http.middlewares.jwt-verify.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.jwt-verify.forwardauth.authResponseHeaders=X-User-Id, X-User-Role, X-Username"

  # ============================================
  # BAZE DE DATE (Neschimbate)
  # ============================================
  user-db:
    image: postgres:16
    container_name: user-db
    ports: ["5430:5432"]
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Luci2004
    volumes: ["user-data:/var/lib/postgresql/data"]
    networks: ["energy-network"]
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d user_db" ]
      interval: 10s
      timeout: 5s
      retries: 5

  device-db:
    image: postgres:16
    container_name: device-db
    ports: ["5431:5432"]
    environment:
      POSTGRES_DB: device_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Luci2004
    volumes: ["device-data:/var/lib/postgresql/data"]
    networks: ["energy-network"]
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d device_db" ]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-db:
    image: postgres:16
    container_name: auth-db
    ports: ["5432:5432"]
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Luci2004
    volumes: ["auth-data:/var/lib/postgresql/data"]
    networks: ["energy-network"]
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d auth_db" ]
      interval: 10s
      timeout: 5s
      retries: 5
  # ============================================
  # PGADMIN - Database Management Tool
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - energy-network
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  # ============================================
  # USER SERVICE (Modificat cu 'priority')
  # ============================================
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    depends_on:
      user-db: { condition: service_healthy }
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/user_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: Luci2004
      SERVER_PORT: 8081
      AUTH_SERVICE_URL: http://auth-service:8083/auth/internal/register
    networks: ["energy-network"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=PathPrefix(`/users`)"
      - "traefik.http.routers.user-service.entrypoints=web"
      - "traefik.http.routers.user-service.middlewares=jwt-verify@docker"
      - "traefik.http.routers.user-service.priority=10" # <-- PRIORITATE MARE
      - "traefik.http.services.user-service.loadbalancer.server.port=8081"

  # ============================================
  # DEVICE SERVICE (Modificat cu 'priority')
  # ============================================
  device-service:
    build:
      context: ./device-service
      dockerfile: Dockerfile
    container_name: device-service
    depends_on:
      device-db: { condition: service_healthy }
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://device-db:5432/device_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: Luci2004
      SERVER_PORT: 8082
    networks: ["energy-network"]
    labels:
      - "traefik.enable=true"
      # Router pentru /devices
      - "traefik.http.routers.device-service-devices.rule=PathPrefix(`/devices`)"
      - "traefik.http.routers.device-service-devices.entrypoints=web"
      - "traefik.http.routers.device-service-devices.middlewares=jwt-verify@docker"
      - "traefik.http.routers.device-service-devices.priority=10" # <-- PRIORITATE MARE
      # Router pentru /user-devices
      - "traefik.http.routers.device-service-user-devices.rule=PathPrefix(`/user-devices`)"
      - "traefik.http.routers.device-service-user-devices.entrypoints=web"
      - "traefik.http.routers.device-service-user-devices.middlewares=jwt-verify@docker"
      - "traefik.http.routers.device-service-user-devices.priority=10" # <-- PRIORITATE MARE
      # Serviciul backend
      - "traefik.http.services.device-service.loadbalancer.server.port=8082"

  # ============================================
  #  AUTHENTICATION MICROSERVICE (Modificat cu 'priority')
  # ============================================
  auth-service:
    build:
      context: ./authentication-service
      dockerfile: Dockerfile
    container_name: auth-service
    depends_on:
      auth-db: { condition: service_healthy }
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://auth-db:5432/auth_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: Luci2004
      SERVER_PORT: 8083
      JWT_SECRET: myVerySecretKeyForJWTTokenGenerationThatShouldBeLongEnough123456
    networks: ["energy-network"]
    labels:
      - "traefik.enable=true"
      # Router pentru /auth (FĂRĂ JWT)
      - "traefik.http.routers.auth-service.rule=PathPrefix(`/auth`)"
      - "traefik.http.routers.auth-service.entrypoints=web"
      - "traefik.http.routers.auth-service.priority=10" # <-- PRIORITATE MARE
      # Serviciul backend
      - "traefik.http.services.auth-service.loadbalancer.server.port=8083"

  # ============================================
  #  FRONTEND SERVICE (Serviciul NOU)
  # ============================================
  frontend-service:
    build:
      # Modifică 'frontend' cu numele folderului tău de frontend
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend-service
    networks:
      - energy-network
    labels:
      - "traefik.enable=true"
      # Această regulă prinde tot traficul către domeniul principal
      - "traefik.http.routers.frontend-service.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend-service.entrypoints=web"
      - "traefik.http.routers.frontend-service.priority=1" # <-- PRIORITATE MICĂ
      # Nginx din container rulează pe portul 80
      - "traefik.http.services.frontend-service.loadbalancer.server.port=80"

networks:
  energy-network:
    driver: bridge

volumes:
  user-data:
  device-data:
  auth-data:
  pgadmin-data: